name: Docker Build and Push
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: "Build latest and versioned docker tags"
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: deepmind/kapitan
          add_git_labels: true
          tag_with_ref: true
          dockerfile: Dockerfile
      - name: Strip git ref prefix from tag version and store in TAG_VERSION VAR
        run: echo ::set-env name=TAG_VERSION::${GITHUB_REF#refs/*/}
      - name: Building/Pushing Tag Version
        run: |
          echo ${{ env.TAG_VERSION }}
      - name: "Build latest ci tag"
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: deepmind/kapitan
          add_git_labels: true
          if: "env.TAG_VERSION == 'master'"
          tags: ci
          dockerfile: Dockerfile.ci
      - name: "Build versioned ci tag"
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: deepmind/kapitan
          add_git_labels: true
          if: "startsWith(github.ref, 'refs/tags/')"
          tags: ${{ format('{0}-ci', env.TAG_VERSION ) }}
          dockerfile: Dockerfile.ci
