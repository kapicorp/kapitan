



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Compiling components/templates - Kapitan documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#kapitan-compile" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Kapitan documentation" aria-label="Kapitan documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Kapitan documentation
            </span>
            <span class="md-header-nav__topic">
              
                Compiling components/templates
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/deepmind/kapitan/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    deepmind/kapitan
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Kapitan documentation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Kapitan documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/deepmind/kapitan/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    deepmind/kapitan
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Getting started
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Getting started
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kapitan_overview/" title="Kapitan Overview" class="md-nav__link">
      Kapitan Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../inventory/" title="Inventory" class="md-nav__link">
      Inventory
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Compiling components/templates
      </label>
    
    <a href="./" title="Compiling components/templates" class="md-nav__link md-nav__link--active">
      Compiling components/templates
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#specifying-inputs-and-outputs" class="md-nav__link">
    Specifying inputs and outputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-input-types" class="md-nav__link">
    Supported input types
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jinja2" class="md-nav__link">
    jinja2
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-inventory-in-jinja2" class="md-nav__link">
    Using the inventory in jinja2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jinja2-custom-filters" class="md-nav__link">
    Jinja2 custom filters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jsonnet" class="md-nav__link">
    jsonnet
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-inventory-in-jsonnet" class="md-nav__link">
    Using the inventory in jsonnet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-functions" class="md-nav__link">
    Callback functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jsonschema-validation-from-jsonnet" class="md-nav__link">
    Jsonschema validation from jsonnet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jinja2-jsonnet-templating" class="md-nav__link">
    Jinja2 jsonnet templating
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kadet" class="md-nav__link">
    kadet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helm" class="md-nav__link">
    helm
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-binding-from-source" class="md-nav__link">
    Building the binding from source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helm-subcharts" class="md-nav__link">
    Helm subcharts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy" class="md-nav__link">
    Copy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Kapitan features
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Kapitan features
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../secrets/" title="Secret management" class="md-nav__link">
      Secret management
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../validate/" title="Manifest validation" class="md-nav__link">
      Manifest validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../external_dependencies/" title="External dependency management" class="md-nav__link">
      External dependency management
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Miscellaneous
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Miscellaneous
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../CI/" title="Continuous Integration" class="md-nav__link">
      Continuous Integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pyenv-scl/" title="Set up kapitan on older Python systems" class="md-nav__link">
      Set up kapitan on older Python systems
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../usage/" title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../proposals/" title="Proposals" class="md-nav__link">
      Proposals
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../example-kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../example-terraform/" title="Terraform" class="md-nav__link">
      Terraform
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#specifying-inputs-and-outputs" class="md-nav__link">
    Specifying inputs and outputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-input-types" class="md-nav__link">
    Supported input types
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jinja2" class="md-nav__link">
    jinja2
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-inventory-in-jinja2" class="md-nav__link">
    Using the inventory in jinja2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jinja2-custom-filters" class="md-nav__link">
    Jinja2 custom filters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jsonnet" class="md-nav__link">
    jsonnet
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-inventory-in-jsonnet" class="md-nav__link">
    Using the inventory in jsonnet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-functions" class="md-nav__link">
    Callback functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jsonschema-validation-from-jsonnet" class="md-nav__link">
    Jsonschema validation from jsonnet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jinja2-jsonnet-templating" class="md-nav__link">
    Jinja2 jsonnet templating
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kadet" class="md-nav__link">
    kadet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helm" class="md-nav__link">
    helm
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-binding-from-source" class="md-nav__link">
    Building the binding from source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helm-subcharts" class="md-nav__link">
    Helm subcharts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy" class="md-nav__link">
    Copy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/deepmind/kapitan/edit/master/docs/compile.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="kapitan-compile">Kapitan compile</h1>
<p><strong>Note:</strong> make sure to read up on <a href="../inventory/">inventory</a> before moving on.</p>
<h2 id="specifying-inputs-and-outputs">Specifying inputs and outputs</h2>
<p>Input types can be specified in the inventory under <code>kapitan.compile</code> in the following format:</p>
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span>
  <span class="nt">kapitan</span><span class="p">:</span>
    <span class="nt">compile</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">output_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;output_path_in_target_dir&gt;</span>
      <span class="nt">input_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jinja2 | jsonnet | kadet | helm | copy</span>
      <span class="nt">prune</span><span class="p">:</span> <span class="nt">&lt;boolean&gt; (Default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global --prune)</span>
      <span class="nt">input_paths</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">path/to/input/dir/or/file</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">globbed/path/*/main.jsonnet</span>
      <span class="nt">output_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;output_type_specific_to_input_type&gt;</span>
</code></pre></div>

<h2 id="supported-input-types">Supported input types</h2>
<p>Kapitan supports the following input template types:</p>
<ul>
<li><a href="#jinja2">jinja2</a></li>
<li><a href="#jsonnet">jsonnet</a></li>
<li><a href="#kadet">kadet</a> (alpha)</li>
<li><a href="#helm">helm</a> (alpha)</li>
<li><a href="#copy">copy</a></li>
</ul>
<h3 id="jinja2">jinja2</h3>
<p>This renders jinja2 templates, typically stored in <code>templates/</code> directory, such as README, scripts and config files. Refer to <a href="http://jinja.palletsprojects.com/en/2.10.x/templates/">jinja2 docs</a> to understand how the template engine works.</p>
<p>For Jinja2, <code>input_paths</code> can be either a file or a directory: in case of a directory, all the templates in the directory will be rendered and outputted to <code>output_path</code>.</p>
<p><em>Supported output types</em>: N/A (no need to specify <code>output_type</code>)</p>
<h4 id="using-the-inventory-in-jinja2">Using the inventory in jinja2</h4>
<p>Jinja2 types will pass the "inventory" and whatever target vars as context keys in your template.</p>
<p>This snippet renders the same java_opts for the elasticsearch data role:</p>
<div class="highlight"><pre><span></span><code>java_opts for elasticsearch data role are: {{ inventory.parameters.elasticsearch.roles.data.java_opts }}
</code></pre></div>

<h4 id="jinja2-custom-filters">Jinja2 custom filters</h4>
<p>We support the following custom filters for use in Jinja2 templates:</p>
<div class="highlight"><pre><span></span><code>sha256 - SHA256 hashing of text e.g. {{ text | sha256 }}
yaml - Dump text as YAML e.g. {{ text | yaml }}
b64encode - base64 encode text e.g. {{ text | b64encode }}
b64decode - base64 decode text e.g. {{ text | b64decode }}
fileglob - return list of matched regular files for glob e.g. {{ ./path/file* | fileglob }}
bool - return the bool for value e.g. {{ yes | bool }}
to_datetime - return datetime object for string e.g. {{ &quot;2019-03-07 13:37:00&quot; | to_datetime }}
strftime - return current date string for format e.g. {{ &quot;%a, %d %b %Y %H:%M&quot; | strftime }}
regex_replace - perform a re.sub returning a string e.g. {{ hello world | regex_replace(pattern=&quot;world&quot;, replacement=&quot;kapitan&quot;) }}
regex_escape - escape all regular expressions special characters from string e.g. {{ &quot;+s[a-z].*&quot; | regex_escape }}
regex_search - perform re.search and return the list of matches or a backref e.g. {{ hello world | regex_search(&quot;world.*&quot;) }}
regex_findall - perform re.findall and return the list of matches as array e.g. {{ hello world | regex_findall(&quot;world.*&quot;) }}
ternary - value ? true_val : false_val e.g. {{ condition | ternary(&quot;yes&quot;, &quot;no&quot;) }}
shuffle - randomly shuffle elements of a list {{ [1, 2, 3, 4, 5] | shuffle }}
reveal_maybe - reveal ref/secret tag only if `compile --reveal` flag is set e.g. {{ &quot;?{ref:my_ref}&quot; | reveal_maybe }}
</code></pre></div>

<p>You can also provide path to your custom filter modules in CLI. By default, you can put your filters in <code>lib/jinja2_filters.py</code> and they will automatically get loaded.</p>
<h3 id="jsonnet">jsonnet</h3>
<p>Jsonnet is a superset of json format that includes features such as conditionals, variables and imports. Refer to <a href="https://jsonnet.org/learning/tutorial.html">jsonnet docs</a> to understand how it works.</p>
<p>Note: unlike jinja2 templates, one jsonnet template can output multiple files (one per object declared in the file).</p>
<p><em>Supported output types:</em></p>
<ul>
<li>yaml (default)</li>
<li>json</li>
</ul>
<h4 id="using-the-inventory-in-jsonnet">Using the inventory in jsonnet</h4>
<p>Typical jsonnet files would start as follows:</p>
<div class="highlight"><pre><span></span><code>local kap = import &quot;lib/kapitan.libjsonnet&quot;;
local inventory = kap.inventory();
</code></pre></div>

<p>The first line is required to access the kapitan inventory values.</p>
<p>On the second line, <code>inventory()</code> callback is used to initialise a local variable through which inventory values for this target can be referenced. For example, the script below</p>
<div class="highlight"><pre><span></span><code>local kap = import &quot;lib/kapitan.libjsonnet&quot;;
local inventory = kap.inventory();

{
    &quot;data_java_opts&quot;: inventory.parameters.elasticsearch.roles.data.java_opts,
}
</code></pre></div>

<p>imports the inventory for the target you're compiling and returns the java_opts for the elasticsearch data role.</p>
<p>Note: The dictionary keys of the jsonnet object are used as filenames for the generated output files.
If your jsonnet is not a dictionary, but is a valid json(net) object, then the output filename will be the same as the input filename. E.g. <code>'my_string'</code> is inside <code>templates/input_file.jsonnet</code> so the generated output file will be named <code>input_file.json</code> for example and will contain <code>"my_string"</code>.</p>
<h4 id="callback-functions">Callback functions</h4>
<p>In addition, importing <code>kapitan.libjsonnet</code> makes available the following native_callback functions gluing reclass to jsonnet (amongst others):</p>
<div class="highlight"><pre><span></span><code>yaml_load - returns a json string of the specified yaml file
yaml_load_stream - returns a list of json strings of the specified yaml file
yaml_dump - returns a string yaml from a json string
yaml_dump_stream - returns a string yaml stream from a json string
file_read - reads the file specified
jinja2_template - renders the jinja2 file with context specified
sha256_string - returns sha256 of string
gzip_b64 - returns base64 encoded gzip of obj
inventory - returns a dictionary with the inventory for target
jsonschema - validates obj with schema, returns object with &#39;valid&#39; and &#39;reason&#39; keys
</code></pre></div>

<h5 id="jsonschema-validation-from-jsonnet">Jsonschema validation from jsonnet</h5>
<p>Given the follow example inventory:</p>
<div class="highlight"><pre><span></span><code>mysql:
  storage: 10G
  storage_class: standard
  image: mysql:latest
</code></pre></div>

<p>The yaml inventory structure can be validated with the new <code>jsonschema()</code> function:</p>
<div class="highlight"><pre><span></span><code>local schema = {
    type: &quot;object&quot;,
    properties: {
        storage: { type: &quot;string&quot;, pattern: &quot;^[0-9]+[MGT]{1}$&quot;},
        image: { type: &quot;string&quot; },
    }
};
// run jsonschema validation
local validation = kap.jsonschema(inv.parameters.mysql, schema);
// assert valid, otherwise error with validation.reason
assert validation.valid: validation.reason;
</code></pre></div>

<p>If <code>validation.valid</code> is not true, it will then fail compilation and display <code>validation.reason</code>.</p>
<p>For example, if defining the <code>storage</code> value with an invalid pattern (<code>10Z</code>), compile fails:</p>
<div class="highlight"><pre><span></span><code>Jsonnet error: failed to compile /code/components/mysql/main.jsonnet:
 RUNTIME ERROR: &#39;10Z&#39; does not match &#39;^[0-9]+[MGT]{1}$&#39;

Failed validating &#39;pattern&#39; in schema[&#39;properties&#39;][&#39;storage&#39;]:
    {&#39;pattern&#39;: &#39;^[0-9]+[MGT]{1}$&#39;, &#39;type&#39;: &#39;string&#39;}

On instance[&#39;storage&#39;]:
    &#39;10Z&#39;

/code/mysql/main.jsonnet:(19:1)-(43:2)

Compile error: failed to compile target: minikube-mysql
</code></pre></div>

<h5 id="jinja2-jsonnet-templating">Jinja2 jsonnet templating</h5>
<p>The following jsonnet snippet renders the jinja2 template in <code>templates/got.j2</code>:</p>
<div class="highlight"><pre><span></span><code>local kap = import &quot;lib/kapitan.libjsonnet&quot;;

{
    &quot;jon_snow&quot;: kap.jinja2_template(&quot;templates/got.j2&quot;, { is_dead: false }),
}
</code></pre></div>

<p>It's up to you to decide what the output is.</p>
<h3 id="kadet">kadet</h3>
<p>Kadet is an extensible input type that enables you to generate templates using python. The key benefit being the ability to utilize familiar programing principles while having access to kapitan's powerful inventory system. </p>
<p>A library that defines resources as classes using the Base Object class is required. These can then be utilized within components to render output. </p>
<p>The following functions are provided by the class <code>BaseObj()</code>.</p>
<p>Method definitions:</p>
<ul>
<li><code>new()</code>: Provides parameter checking capabilities</li>
<li><code>body()</code>: Enables in-depth parameter configuration</li>
</ul>
<p>Method functions:</p>
<ul>
<li><code>root()</code>: Defines values that will be compiled into the output</li>
<li><code>need()</code>: Ability to check &amp; define input parameters</li>
<li><code>update_root()</code>: Updates the template file associated with the class</li>
</ul>
<p>A class can be a resource such as a kubernetes Deployment as shown here:</p>
<div class="highlight"><pre><span></span><code>class Deployment(BaseObj):
    def new(self):
        self.need(&quot;name&quot;, &quot;name string needed&quot;)
        self.need(&quot;labels&quot;, &quot;labels dict needed&quot;)
        self.need(&quot;containers&quot;, &quot;containers dict needed&quot;)
        self.update_root(&quot;lib/kubelib/deployment.yml&quot;)

    def body(self):
        self.root.metadata.name = self.kwargs.name
        self.root.metadata.namespace = inv.parameters.target_name
        self.root.spec.template.metadata.labels = self.kwargs.labels
        self.root.spec.template.spec.containers = self.kwargs.containers
</code></pre></div>

<p>The deployment is an <code>BaseObj()</code> which has two main functions. New can be used to perform parameter validation &amp; template compilation. Body is utilized to set those parameters to be rendered. <code>self.root.metadata.name</code> is a direct reference to a key in the corresponding yaml.</p>
<p>We have established that you may define a library which holds information on classes that represent resource objects. The library is then utilized by defined components to generate the required output.</p>
<p>Here we import <code>kubelib</code> using <code>load_from_search_paths()</code>. We then use kubelib to access the defined object classes. In this instance the Deployment &amp; Service resource class.</p>
<div class="highlight"><pre><span></span><code>...
kubelib = kadet.load_from_search_paths(&quot;kubelib&quot;)
...
name = &quot;nginx&quot;
labels = kadet.BaseObj.from_dict({&quot;app&quot;: name})
nginx_container = kubelib.Container(
    name=name, image=inv.parameters.nginx.image, ports=[{&quot;containerPort&quot;: 80}]
)
...
def main():
    output = kadet.BaseObj()
    output.root.nginx_deployment = kubelib.Deployment(name=name, labels=labels, containers=[nginx_container])
    output.root.nginx_service = kubelib.Service(
        name=name, labels=labels, ports=[svc_port], selector=svc_selector
    )
    return output
</code></pre></div>

<p>Kadet uses a library called <a href="https://github.com/mewwts/addict">addict</a> to organise the parameters inline with the yaml templates.
As shown above we create a <code>BaseObject()</code> named output. We update the root of this output with the data structure returned from kubelib. This output is what is then returned to kapitan to be compiled into the desired output type.</p>
<p>For a deeper understanding of this input type please review the proposal document at <a href="/kap_proposals/kap_0_kadet">kadet</a> &amp; the examples located at <code>examples/kubernetes/components/nginx</code>.</p>
<p><em>Supported output types:</em></p>
<ul>
<li>yaml (default)</li>
<li>json</li>
</ul>
<h3 id="helm">helm</h3>
<p>This is a Python binding to <code>helm template</code> command for users with helm charts. This does not require the helm executable, and the templates are rendered without the Tiller server.</p>
<p>Unlike other input types, Helm input types support the following additional parameters under <code>kapitan.compile</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span>
  <span class="nt">kapitan</span><span class="p">:</span>
    <span class="nt">compile</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">output_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;output_path&gt;</span>
      <span class="nt">input_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">helm</span>
      <span class="nt">input_paths</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;chart_path&gt;</span>
      <span class="nt">helm_values</span><span class="p">:</span>
        <span class="l l-Scalar l-Scalar-Plain">&lt;object_with_values_to_override&gt;</span>
      <span class="nt">helm_params</span><span class="p">:</span>
        <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;substitutes_.Release.Namespace&gt;</span>
        <span class="nt">name_template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;namespace_template&gt;</span>
        <span class="nt">release_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;chart_release_name&gt;</span>
</code></pre></div>

<p><code>helm_values</code> is an object containing values specified that will override the default values in the input chart. This has exactly the same effect as specifying <code>--values custom_values.yml</code> for <code>helm template</code> command where <code>custom_values.yml</code> structure mirrors that of <code>helm_values</code>.</p>
<p><code>helm_params</code> correspond to the options for <code>helm template</code> as follows:</p>
<ul>
<li>
<p>namespace: equivalent of <code>--namespace</code> option: note that due to the restriction on <code>helm template</code> command, specifying the namespace does not automatically add <code>metadata.namespace</code> property to the resources. Therefore, users are encourage to explicitly specify in all resources:</p>
<div class="highlight"><pre><span></span><code><span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Release.Namespace</span> <span class="p p-Indicator">}}</span> <span class="c1"># or any other custom values</span>
</code></pre></div>

</li>
<li>
<p>name_template: equivalent of <code>--name-template</code> option</p>
</li>
<li>release_name: equivalent of <code>--name</code> option</li>
</ul>
<p>See the <a href="https://helm.sh/docs/helm/#helm-template">helm doc</a> for further detail.</p>
<h4 id="example">Example</h4>
<p>Let's use <a href="https://github.com/helm/charts/tree/master/stable/nginx-ingress">nginx-ingress</a> helm chart as the input. Using <a href="../external_dependencies/">kapitan dependency manager</a>, this chart can be fetched via a URL as listed in <a href="https://helm.nginx.com/stable/index.yaml">https://helm.nginx.com/stable/index.yaml</a>.</p>
<p><em>On a side note, <code>https://helm.nginx.com/stable/</code> is the chart repository URL which you would <code>helm repo add</code>, and this repository should contain <code>index.yaml</code> that lists out all the available charts and their URLs. By locating this <code>index.yaml</code> file, you can locate all the charts available in the repository.</em></p>
<p>We can use version 0.3.3 found at <a href="https://helm.nginx.com/stable/nginx-ingress-0.3.3.tgz">https://helm.nginx.com/stable/nginx-ingress-0.3.3.tgz</a>. We can create a simple target file as <code>inventory/targets/nginx-from-chart.yml</code> whose content is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span>
  <span class="nt">kapitan</span><span class="p">:</span>
    <span class="nt">vars</span><span class="p">:</span>
      <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-from-chart</span>
    <span class="nt">dependencies</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
      <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://helm.nginx.com/stable/nginx-ingress-0.3.3.tgz</span>
      <span class="nt">unpack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
      <span class="nt">output_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">components/charts</span>
    <span class="nt">compile</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">output_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
        <span class="nt">input_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">helm</span>
        <span class="nt">input_paths</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">components/charts/nginx-ingress</span>
        <span class="nt">helm_values</span><span class="p">:</span>
          <span class="nt">controller</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-controller</span>
            <span class="nt">image</span><span class="p">:</span>
              <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">custom_repo</span>
        <span class="nt">helm_params</span><span class="p">:</span>
          <span class="nt">release_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-first-release-name</span>
          <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-first-namespace</span>
</code></pre></div>

<p>To compile this target, run:</p>
<div class="highlight"><pre><span></span><code>$ kapitan compile --fetch
Dependency https://helm.nginx.com/stable/nginx-ingress-0.3.3.tgz : fetching now
Dependency https://helm.nginx.com/stable/nginx-ingress-0.3.3.tgz : successfully fetched
Dependency https://helm.nginx.com/stable/nginx-ingress-0.3.3.tgz : extracted to components/charts
Compiled nginx-from-chart <span class="o">(</span><span class="m">0</span>.07s<span class="o">)</span>
</code></pre></div>

<p>The chart is fetched before compile, which creates <code>components/charts/nginx-ingress</code> folder that is used as the <code>input_paths</code>  for the helm input type. To confirm if the <code>helm_values</code> actually has overridden the default values, we can try:</p>
<div class="highlight"><pre><span></span><code>$ grep <span class="s2">&quot;my-controller&quot;</span> compiled/nginx-from-chart/nginx-ingress/templates/controller-deployment.yaml
  name: my-controller
      app: my-controller
        app: my-controller
</code></pre></div>

<h4 id="building-the-binding-from-source">Building the binding from source</h4>
<p>Run</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> kapitan/inputs/helm
./build.sh
</code></pre></div>

<p>This requires Go &gt;= 1.12.</p>
<h4 id="helm-subcharts">Helm subcharts</h4>
<p>This binding supports helm subcharts. However, since the <a href="../external_dependencies/">external dependency manager</a> does not parse <code>requirements.yaml</code> in order to detect chart dependencies, you are required to manually download the entire chart including the parent charts.</p>
<p><em>Supported output types:</em> N/A (no need to specify <code>output_type</code>)</p>
<h3 id="copy">Copy</h3>
<p>This input type simply copies the input templates to the output directory without any rendering/processing.
For Copy, <code>input_paths</code> can be either a file or a directory: in case of a directory, all the templates in the directory will be copied and outputted to <code>output_path</code>.</p>
<p><em>Supported output types</em>: N/A (no need to specify <code>output_type</code>)</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../inventory/" title="Inventory" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Inventory
              </span>
            </div>
          </a>
        
        
          <a href="../secrets/" title="Secret management" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Secret management
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>